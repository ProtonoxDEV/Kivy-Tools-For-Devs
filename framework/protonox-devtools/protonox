#!/usr/bin/env python3
from __future__ import annotations

import argparse
import subprocess
import sys
from pathlib import Path


def cmd_doctor(args: argparse.Namespace) -> int:
    print("Protonox Doctor")
    print("python", sys.version)
    return 0


def cmd_create(args: argparse.Namespace) -> int:
    print(f"Creating app {args.name} from template {args.template}")
    return 0


def cmd_build_android(args: argparse.Namespace) -> int:
    print("Building Android APK via buildozer...")
    return subprocess.call(["buildozer", "-v", "android", "debug"])


def cmd_build_desktop(args: argparse.Namespace) -> int:
    print("Building desktop distribution placeholder")
    return 0


def main() -> int:
    parser = argparse.ArgumentParser(prog="protonox", description="Protonox CLI")
    sub = parser.add_subparsers(dest="cmd", required=True)

    p_doc = sub.add_parser("doctor", help="Check environment")
    p_doc.set_defaults(func=cmd_doctor)

    p_create = sub.add_parser("create", help="Create a new app")
    p_create.add_argument("name")
    p_create.add_argument("--template", default="protonox-app-complete")
    p_create.set_defaults(func=cmd_create)

    p_ba = sub.add_parser("build", help="Build targets")
    p_ba.add_argument("target", choices=["android", "desktop"])
    p_ba.set_defaults(func=lambda a: cmd_build_android(a) if a.target == "android" else cmd_build_desktop(a))

    args = parser.parse_args()
    return int(args.func(args))


if __name__ == "__main__":
    raise SystemExit(main())
